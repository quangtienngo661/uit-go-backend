openapi: 3.0.3
info:
  title: UIT-Go API Gateway
  version: 1.0.0
  description: |
    REST surface exposed by the API Gateway. All protected routes require a Bearer JWT issued by Supabase.
servers:
  - url: https://api.example.com
tags:
  - name: Health
  - name: Auth
  - name: Users
  - name: Trips
  - name: Drivers

paths:
  /:
    get:
      tags: [Health]
      summary: Root ping
      responses:
        '200':
          description: OK
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: ok }
                  version: { type: string, example: dev }
  /auth/login:
    post:
      tags: [Auth]
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginRequest' }
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /auth/register/user:
    post:
      tags: [Auth]
      summary: Register passenger
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterUserRequest' }
      responses:
        '201': { $ref: '#/components/responses/Success' }
  /auth/register/driver:
    post:
      tags: [Auth]
      summary: Register driver
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterDriverRequest' }
      responses:
        '201': { $ref: '#/components/responses/Success' }
  /auth/logout:
    get:
      tags: [Auth]
      summary: Logout (Bearer)
      security: [{ bearerAuth: [] }]
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /auth/check-verification:
    get:
      tags: [Auth]
      summary: Check verification (Bearer)
      security: [{ bearerAuth: [] }]
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /auth/only-driver:
    get:
      tags: [Auth]
      summary: Driver-only guard test
      security: [{ bearerAuth: [] }]
      responses:
        '200': { $ref: '#/components/responses/Success' }

  /users:
    get:
      tags: [Users]
      summary: Test endpoint
      security: [{ bearerAuth: [] }]
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /users/passengers:
    post:
      tags: [Users]
      summary: Create passenger profile
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreatePassenger' }
      responses:
        '201': { $ref: '#/components/responses/Success' }
    get:
      tags: [Users]
      summary: List passengers
      security: [{ bearerAuth: [] }]
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /users/drivers:
    post:
      tags: [Users]
      summary: Create driver profile
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateDriverProfile' }
      responses:
        '201': { $ref: '#/components/responses/Success' }
    get:
      tags: [Users]
      summary: List drivers
      security: [{ bearerAuth: [] }]
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /users/passengers/{id}:
    get:
      tags: [Users]
      summary: Get passenger
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200': { $ref: '#/components/responses/Success' }
    patch:
      tags: [Users]
      summary: Update passenger
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UpdatePassenger' }
      responses:
        '200': { $ref: '#/components/responses/Success' }
    delete:
      tags: [Users]
      summary: Delete passenger
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /users/drivers/{id}:
    get:
      tags: [Users]
      summary: Get driver profile
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200': { $ref: '#/components/responses/Success' }
    patch:
      tags: [Users]
      summary: Update driver profile
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UpdateDriverProfile' }
      responses:
        '200': { $ref: '#/components/responses/Success' }
    delete:
      tags: [Users]
      summary: Delete driver profile
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /users/current-profile:
    get:
      tags: [Users]
      summary: Get current profile
      security: [{ bearerAuth: [] }]
      responses:
        '200': { $ref: '#/components/responses/Success' }
    patch:
      tags: [Users]
      summary: Update current profile
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object }
      responses:
        '200': { $ref: '#/components/responses/Success' }

  /trips:
    post:
      tags: [Trips]
      summary: Create trip
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateTripRequest' }
      responses:
        '201': { $ref: '#/components/responses/Success' }
  /trips/{tripId}:
    get:
      tags: [Trips]
      summary: Get trip by id
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/TripId'
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /trips/{tripId}/cancel:
    patch:
      tags: [Trips]
      summary: Cancel trip
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/TripId'
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /trips/{tripId}/assign-driver:
    post:
      tags: [Trips]
      summary: Assign driver
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/TripId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                driverId: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /trips/{tripId}/start:
    patch:
      tags: [Trips]
      summary: Start trip
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/TripId'
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /trips/{tripId}/complete:
    patch:
      tags: [Trips]
      summary: Complete trip
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/TripId'
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /trips/{tripId}/rating:
    post:
      tags: [Trips]
      summary: Rate trip
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/TripId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RateTripRequest' }
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /trips/user/{userId}:
    get:
      tags: [Trips]
      summary: Trip history by user
      security: [{ bearerAuth: [] }]
      parameters:
        - name: userId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Success' }

  /drivers/search:
    get:
      tags: [Drivers]
      summary: Find nearby drivers
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: lat
          schema: { type: number }
        - in: query
          name: lng
          schema: { type: number }
        - in: query
          name: radius
          schema: { type: number }
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /drivers/{driverId}:
    get:
      tags: [Drivers]
      summary: Get driver profile
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/DriverId'
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /drivers/{driverId}/location:
    patch:
      tags: [Drivers]
      summary: Update driver location
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/DriverId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UpdateDriverLocation' }
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /drivers/{driverId}/status:
    patch:
      tags: [Drivers]
      summary: Update driver status
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/DriverId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UpdateDriverStatus' }
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /drivers/{driverId}/accept-trip:
    post:
      tags: [Drivers]
      summary: Accept trip
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/DriverId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tripId: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Success' }
  /drivers/{driverId}/reject-trip:
    post:
      tags: [Drivers]
      summary: Reject trip
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/DriverId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tripId: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Success' }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    IdParam:
      name: id
      in: path
      required: true
      schema: { type: string }
    TripId:
      name: tripId
      in: path
      required: true
      schema: { type: string }
    DriverId:
      name: driverId
      in: path
      required: true
      schema: { type: string }

  responses:
    Success:
      description: Success envelope
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { type: string, example: ok }
              statusCode: { type: integer, example: 200 }
              data: { nullable: true }

  schemas:
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, minLength: 6 }
    RegisterUserRequest:
      type: object
      required: [email, password, fullName, phone]
      properties:
        email: { type: string, format: email }
        password: { type: string, minLength: 6 }
        fullName: { type: string }
        phone: { type: string, pattern: '^[0-9]{10,15}$' }
    RegisterDriverRequest:
      allOf:
        - $ref: '#/components/schemas/RegisterUserRequest'
        - type: object
          required: [licenseNumber, vehicleType, licensePlate, vehicleModel, vehicleColor]
          properties:
            licenseNumber: { type: string }
            vehicleType: { $ref: '#/components/schemas/VehicleType' }
            licensePlate: { type: string }
            vehicleModel: { type: string }
            vehicleColor: { type: string }
    CreatePassenger:
      type: object
      required: [fullName, phone]
      properties:
        fullName: { type: string }
        phone: { type: string }
    UpdatePassenger:
      type: object
      properties:
        fullName: { type: string }
        phone: { type: string }
    CreateDriverProfile:
      type: object
      required: [fullName, phone, licenseNumber, vehicleType, licensePlate, vehicleModel, vehicleColor]
      properties:
        fullName: { type: string }
        phone: { type: string }
        licenseNumber: { type: string }
        vehicleType: { $ref: '#/components/schemas/VehicleType' }
        licensePlate: { type: string }
        vehicleModel: { type: string }
        vehicleColor: { type: string }
    UpdateDriverProfile:
      type: object
      properties:
        fullName: { type: string }
        phone: { type: string }
        licenseNumber: { type: string }
        vehicleType: { $ref: '#/components/schemas/VehicleType' }
        licensePlate: { type: string }
        vehicleModel: { type: string }
        vehicleColor: { type: string }
    CreateTripRequest:
      type: object
      required: [passengerId, pickup, dropoff, vehicleType]
      properties:
        passengerId: { type: string }
        pickup: { $ref: '#/components/schemas/Coordinate' }
        dropoff: { $ref: '#/components/schemas/Coordinate' }
        vehicleType: { $ref: '#/components/schemas/VehicleType' }
        distanceKm: { type: number }
        estimatedPrice: { type: number }
        routeGeometry: { type: string }
    RateTripRequest:
      type: object
      required: [ratedBy, ratedUser, raterRole, rating]
      properties:
        ratedBy: { type: string }
        ratedUser: { type: string }
        raterRole: { $ref: '#/components/schemas/Role' }
        rating: { type: integer, minimum: 1, maximum: 5 }
        comment: { type: string }
    UpdateDriverLocation:
      type: object
      required: [lng, lat]
      properties:
        lng: { type: number }
        lat: { type: number }
    UpdateDriverStatus:
      type: object
      required: [status]
      properties:
        status: { $ref: '#/components/schemas/DriverStatus' }
    Coordinate:
      type: object
      properties:
        lng: { type: number }
        lat: { type: number }
        address: { type: string }
    VehicleType:
      type: string
      enum: [VEHICLE_TYPE_BIKE, VEHICLE_TYPE_SEDAN, VEHICLE_TYPE_SUV, VEHICLE_TYPE_SEVEN_SEAT]
    Role:
      type: string
      enum: [ROLE_PASSENGER, ROLE_DRIVER]
    DriverStatus:
      type: string
      enum: [DRIVER_STATUS_OFFLINE, DRIVER_STATUS_ONLINE, DRIVER_STATUS_BUSY]
