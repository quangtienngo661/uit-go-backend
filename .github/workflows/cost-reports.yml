name: Monthly Cost Reports

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 0 1 * *'  # Run on 1st day of each month at midnight UTC

permissions:
  contents: write
  issues: write

jobs:
  generate-cost-reports:
    name: Generate AWS Cost Reports
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1
      
      - name: Create reports directory
        run: mkdir -p reports
      
      - name: Generate Cost Report - By Service
        run: |
          # Get current month and last month dates
          START_DATE=$(date -u -d "last month" +%Y-%m-01)
          END_DATE=$(date -u +%Y-%m-01)
          
          echo "Generating cost report from $START_DATE to $END_DATE"
          
          aws ce get-cost-and-usage \
            --time-period Start=$START_DATE,End=$END_DATE \
            --granularity DAILY \
            --metrics "UnblendedCost" "UsageQuantity" \
            --group-by Type=TAG,Key=Service \
            --filter file://.github/workflows/cost-filter.json \
            --output json > reports/cost-by-service.json
          
          # Create human-readable table
          echo "# AWS Cost Report - By Service" > reports/cost-by-service.md
          echo "Period: $START_DATE to $END_DATE" >> reports/cost-by-service.md
          echo "" >> reports/cost-by-service.md
          
          # Parse JSON and create markdown table (simplified)
          cat reports/cost-by-service.json | jq -r '.ResultsByTime[] | .TimePeriod.Start' | head -1 >> reports/cost-by-service.md
      
      - name: Generate Cost Report - By Environment
        run: |
          START_DATE=$(date -u -d "last month" +%Y-%m-01)
          END_DATE=$(date -u +%Y-%m-01)
          
          aws ce get-cost-and-usage \
            --time-period Start=$START_DATE,End=$END_DATE \
            --granularity MONTHLY \
            --metrics "UnblendedCost" \
            --group-by Type=TAG,Key=Environment \
            --filter file://.github/workflows/cost-filter.json \
            --output json > reports/cost-by-environment.json
      
      - name: Generate Summary Report
        run: |
          START_DATE=$(date -u -d "last month" +%Y-%m-01)
          END_DATE=$(date -u +%Y-%m-01)
          
          # Get total cost
          TOTAL_COST=$(aws ce get-cost-and-usage \
            --time-period Start=$START_DATE,End=$END_DATE \
            --granularity MONTHLY \
            --metrics "UnblendedCost" \
            --filter file://.github/workflows/cost-filter.json \
            --query 'ResultsByTime[0].Total.UnblendedCost.Amount' \
            --output text)
          
          # Create summary
          cat > reports/cost-summary.md << EOF
          # AWS Cost Summary Report
          
          **Period:** $START_DATE to $END_DATE
          **Total Cost:** \$$TOTAL_COST USD
          
          ## Cost Breakdown
          
          See detailed reports:
          - [Cost by Service](./cost-by-service.json)
          - [Cost by Environment](./cost-by-environment.json)
          
          ## Budget Status
          
          - Monthly Budget: \$500 USD
          - Current Spend: \$$TOTAL_COST USD
          - Remaining: \$$(echo "500 - $TOTAL_COST" | bc) USD
          
          ## Service Budgets
          
          | Service | Budget | Status |
          |---------|--------|--------|
          | api-gateway | \$40 | ⏳ Check AWS Console |
          | auth-service | \$30 | ⏳ Check AWS Console |
          | user-service | \$50 | ⏳ Check AWS Console |
          | trip-service | \$60 | ⏳ Check AWS Console |
          | driver-service | \$70 | ⏳ Check AWS Console |
          | notification-service | \$25 | ⏳ Check AWS Console |
          
          ---
          Generated automatically by GitHub Actions
          EOF
      
      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cost-reports-${{ github.run_number }}
          path: reports/
          retention-days: 90
      
      - name: Create GitHub Issue with Summary
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('reports/cost-summary.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Monthly Cost Report - ${new Date().toISOString().slice(0, 7)}`,
              body: summary,
              labels: ['finops', 'cost-report']
            });
      
      - name: Check Budget Alerts
        run: |
          # Get budget utilization
          aws budgets describe-budgets \
            --account-id $(aws sts get-caller-identity --query Account --output text) \
            --output json > reports/budget-status.json
          
          echo "Budget status saved to reports/budget-status.json"
